<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ติดตามความคืบหน้า WIN Leasing 2569</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- PapaParse -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700;800&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #f3f4f6;
            overflow-x: auto;
        }
        
        .card-width {
            width: 375px;
            min-width: 375px;
        }
        
        .text-big {
            font-size: 2.2rem;
            line-height: 1;
            font-weight: 700;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 4px;
            height: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 2px;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 min-h-screen flex flex-col min-w-fit">

    <!-- Header & Filter -->
    <header class="bg-white shadow-sm p-4 sticky top-0 z-50 w-full border-b border-gray-200">
        <div class="flex flex-col md:flex-row justify-start items-center gap-6">
            <h1 class="text-xl font-bold text-blue-900 flex-shrink-0">
                <i class="fa-solid fa-chart-line mr-2"></i>ติดตามความคืบหน้า WIN Leasing 2569
            </h1>
            
            <div class="flex items-center gap-2 text-sm bg-gray-50 p-2 rounded-lg border border-gray-200 shadow-inner">
                <label for="monthFilter" class="font-semibold text-gray-700">เลือกเดือน:</label>
                <select id="monthFilter" class="border border-gray-300 rounded px-2 py-1 focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white">
                    <!-- Options generated by JS -->
                </select>
                <button onclick="loadData()" class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700 transition shadow-sm active:transform active:scale-95">
                    <i class="fa-solid fa-sync-alt mr-1"></i> โหลดข้อมูล
                </button>
            </div>
            <div id="loading-status" class="text-sm text-gray-500 hidden">
                <i class="fa-solid fa-circle-notch fa-spin mr-1"></i> กำลังประมวลผล...
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 p-4 flex gap-4 items-start pb-10" id="dashboard-container">
        <!-- Dashboard cards will be rendered here -->
    </main>

    <script>
        // ==========================================
        // CONFIGURATION
        // ==========================================

        const csvLinks = {
            "มกราคม": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQbGiU3T_1QpG9GkbpY6atvZsjey0RyUq-bC2jSW0d5cVsu_VAYDybE4c-oJJwnwr8OZ4h4lt53MUu8/pub?gid=0&single=true&output=csv", 
            "กุมภาพันธ์": "", 
            "มีนาคม": ""
        };

        const branches = ["รวมทั้งหมด", "บ้านดู่", "พาน", "แม่สาย", "แม่จัน", "ลำพูน", "โอมาคาเสะ", "Car4U"];

        const branchMapping = {
            "โอมาฯ": "โอมาคาเสะ",
            "โอมา": "โอมาคาเสะ",
            "CAR4U": "Car4U",
            "car4u": "Car4U"
        };

        // ตั้งค่าเฉพาะ WIN Finance
        const financeStyles = {
            "WIN": { bg: "#000000", text: "#ff0000" }
        };

        const statusList = [
            "ส่งมอบแล้ว",
            "ผ่านแล้วรอปล่อย",
            "เซ็นแล้วรอตรวจสอบ / อนุมัติเบื้องต้น",
            "รอเซ็นสัญญา",
            "รอเอกสารครบ",
            "รอคนค้ำ",
            "รอเงินดาวน์ครบ",
            "รอไฟแนนซ์",
            "จอง/ยังไม่ได้ส่งไฟแนนซ์",
            "รีเจค",
            "ไม่ผ่านเงื่อนไข / คุณสมบัติไม่ครบ",
            "ยกเลิกเคส",
            "ติดต่อไม่ได้",
            "อื่นๆ"
        ];
        
        const sourceList = [
            "Walk in", "Call in", "เพจ Omakase", "เพจสงวนไทยมือสอง", 
            "เพจมือสองสาขา", "เพจส่วนตัว", "ลูกค้าเก่าแนะนำ", "โยกมาจากรถใหม่", "Tiktok", "อื่นๆ"
        ];

        const sourceStyles = {
            "Walk in": { icon: "fa-person-walking", bg: "bg-stone-100", border: "border-stone-300", text: "text-stone-700" },
            "Call in": { icon: "fa-phone-volume", bg: "bg-teal-100", border: "border-teal-300", text: "text-teal-800" },
            "เพจ Omakase": { icon: "fa-brands fa-facebook", bg: "bg-blue-100", border: "border-blue-300", text: "text-blue-800" },
            "เพจสงวนไทยมือสอง": { icon: "fa-brands fa-facebook", bg: "bg-blue-100", border: "border-blue-300", text: "text-blue-800" },
            "เพจมือสองสาขา": { icon: "fa-brands fa-facebook", bg: "bg-blue-100", border: "border-blue-300", text: "text-blue-800" },
            "Tiktok": { icon: "fa-brands fa-tiktok", bg: "bg-pink-50", border: "border-pink-300", text: "text-pink-800" },
            "อื่นๆ": { icon: "fa-ellipsis", bg: "bg-gray-100", border: "border-gray-300", text: "text-gray-600" }
        };

        const monthAliases = {
            "มกราคม": ["มกราคม", "ม.ค.", "/01/", "/1/", "-01-", "-1-", "jan"],
            "กุมภาพันธ์": ["กุมภาพันธ์", "ก.พ.", "/02/", "/2/", "-02-", "-2-", "feb"],
            "มีนาคม": ["มีนาคม", "มี.ค.", "/03/", "/3/", "-03-", "-3-", "mar"]
        };

        // ==========================================
        // LOGIC
        // ==========================================

        const monthFilter = document.getElementById('monthFilter');
        const container = document.getElementById('dashboard-container');
        const loadingStatus = document.getElementById('loading-status');

        function init() {
            checkProtocol();
            monthFilter.innerHTML = '';
            for (const month in csvLinks) {
                const option = document.createElement('option');
                option.value = month;
                option.textContent = month;
                monthFilter.appendChild(option);
            }
            loadData();
        }

        function checkProtocol() {
            if (window.location.protocol === 'file:') {
                const warningDiv = document.createElement('div');
                warningDiv.className = "bg-amber-100 border-l-4 border-amber-500 text-amber-800 p-4 mb-4 fixed bottom-0 right-0 m-6 z-50 shadow-lg rounded max-w-sm animate-bounce-slow";
                warningDiv.innerHTML = `
                    <p class="font-bold flex items-center"><i class="fa-solid fa-triangle-exclamation mr-2"></i> แจ้งเตือน: เปิดแบบ Offline</p>
                    <p class="text-xs mt-1">คุณกำลังเปิดไฟล์โดยตรง (file://) บราวเซอร์อาจบล็อกการดึงข้อมูลจาก Google Sheets</p>
                    <button onclick="this.parentElement.style.display='none'" class="absolute top-1 right-2 text-amber-600 hover:text-amber-900"><i class="fa-solid fa-xmark"></i></button>
                `;
                document.body.appendChild(warningDiv);
            }
        }

        async function loadData() {
            const selectedMonth = monthFilter.value;
            const url = csvLinks[selectedMonth];

            loadingStatus.classList.remove('hidden');
            container.innerHTML = '';

            if (!url) {
                container.innerHTML = `<div class="w-full text-center text-red-500 font-bold p-10 bg-white rounded shadow">ยังไม่ได้ระบุลิงก์ CSV สำหรับเดือน ${selectedMonth}</div>`;
                loadingStatus.classList.add('hidden');
                return;
            }

            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP Status: ${response.status}`);
                const csvText = await response.text();

                if (csvText.trim().startsWith("<!DOCTYPE html") || csvText.includes("<html")) {
                    throw new Error("ลิงก์ไม่ถูกต้อง (ได้รับ HTML แทน CSV)");
                }

                Papa.parse(csvText, {
                    header: false,
                    skipEmptyLines: true,
                    complete: function(results) {
                        loadingStatus.classList.add('hidden');
                        if (!results.data || results.data.length === 0) {
                            container.innerHTML = `<div class="text-red-500 font-bold p-10">ไม่พบข้อมูลในไฟล์ CSV</div>`;
                            return;
                        }

                        // MANUAL HEADER DETECTION
                        let headerRowIndex = -1;
                        const rawData = results.data;
                        for (let i = 0; i < Math.min(rawData.length, 20); i++) {
                            const rowStr = JSON.stringify(rawData[i]);
                            if (rowStr.includes("สาขา") && (rowStr.includes("สถานะ") || rowStr.includes("Status"))) {
                                headerRowIndex = i;
                                break;
                            }
                        }

                        if (headerRowIndex === -1) {
                            container.innerHTML = `<div class="text-red-500 font-bold p-10">ไม่พบหัวตารางที่ถูกต้อง</div>`;
                            return;
                        }

                        const headers = rawData[headerRowIndex].map(h => h.trim());
                        const cleanData = [];
                        for (let i = headerRowIndex + 1; i < rawData.length; i++) {
                            const row = rawData[i];
                            let obj = {};
                            headers.forEach((h, index) => { obj[h] = row[index] || ""; });
                            cleanData.push(obj);
                        }

                        processData(cleanData, selectedMonth);
                    },
                    error: function(err) {
                        loadingStatus.classList.add('hidden');
                        throw new Error(`Papa Parse Error: ${err.message}`);
                    }
                });
            } catch (error) {
                loadingStatus.classList.add('hidden');
                container.innerHTML = `<div class="text-red-500 font-bold p-10">Error: ${error.message}</div>`;
            }
        }

        // --- Smart Column Finder ---
        function findColumnMap(dataRows) {
            if (!dataRows || dataRows.length === 0) return {};
            const keys = Object.keys(dataRows[0]);
            
            const mapping = {};
            const targets = {
                branch: ["สาขา"],
                bookingMonth: ["เดือนที่ส่งเคส", "เดือนจอง", "เดือน"],
                bookingDate: ["วันที่ส่งเคส", "วันจอง", "วันที่", "date"],
                finance: ["FIN", "ไฟแนนซ์", "Finance"],
                status: ["สถานะเคส", "สถานะ", "Status"],
                source: ["ที่มา", "Source"],
                brand: ["ยี่ห้อ", "Brand"],
                model: ["รุ่นรถ", "รุ่น", "Model"]
            };

            for (const [keyName, searchArr] of Object.entries(targets)) {
                const foundKey = keys.find(k => {
                    const cleanKey = k.replace(/\s+/g, '').toLowerCase();
                    return searchArr.some(s => cleanKey === s.toLowerCase() || cleanKey.includes(s.toLowerCase()));
                });
                mapping[keyName] = foundKey || null;
            }
            return mapping;
        }

        function isMonthMatch(text, monthName) {
            if (!text) return false;
            if (monthName === "Current Data") return true; 
            const aliases = monthAliases[monthName] || [monthName];
            const lowerText = text.toLowerCase();
            return aliases.some(alias => lowerText.includes(alias));
        }

        function processData(data, selectedMonth) {
            const colMap = findColumnMap(data);
            
            let branchData = {};
            branches.forEach(b => {
                branchData[b] = {
                    totalCases: 0,
                    currentCases: 0,
                    carriedOver: 0,
                    finance: {},
                    financeDetails: {}, 
                    status: {},
                    source: {},
                    brands: {},
                    models: []
                };
                Object.keys(financeStyles).forEach(f => branchData[b].finance[f] = { old: 0, current: 0, total: 0 });
                statusList.forEach(s => branchData[b].status[s] = 0);
                sourceList.forEach(s => branchData[b].source[s] = 0);
            });

            data.forEach(row => {
                let branchRaw = (colMap.branch ? row[colMap.branch] : "").trim();
                if (!branchRaw) return;

                const bookingMonth = (colMap.bookingMonth ? row[colMap.bookingMonth] : "").trim();
                const bookingDate = (colMap.bookingDate ? row[colMap.bookingDate] : "").trim();
                const financeRaw = (colMap.finance ? row[colMap.finance] : "").trim();
                
                // กรองเฉพาะเคสที่เป็น WIN เท่านั้น
                if (!financeRaw.toLowerCase().includes("win")) return;

                const statusRaw = (colMap.status ? row[colMap.status] : "").trim();
                const sourceRaw = (colMap.source ? row[colMap.source] : "อื่นๆ").trim();
                const brandRaw = (colMap.brand ? row[colMap.brand] : "").trim();
                const modelRaw = (colMap.model ? row[colMap.model] : "").trim();

                if (branchMapping[branchRaw]) branchRaw = branchMapping[branchRaw];

                let targetBranches = ["รวมทั้งหมด"]; 
                if (branches.includes(branchRaw)) {
                    targetBranches.push(branchRaw);
                } else {
                    const match = branches.find(b => branchRaw.includes(b));
                    if(match) targetBranches.push(match);
                }

                targetBranches.forEach(bKey => {
                    const stats = branchData[bKey];
                    if (!stats) return;

                    stats.totalCases++;

                    let isCurrent = false;
                    if (selectedMonth === "Current Data") isCurrent = true; 
                    else if (isMonthMatch(bookingMonth, selectedMonth) || isMonthMatch(bookingDate, selectedMonth)) isCurrent = true;

                    if (isCurrent) stats.currentCases++;
                    else stats.carriedOver++;

                    // Finance Logic - กำหนดเป็น WIN
                    let financeKey = "WIN";
                    if (!stats.finance[financeKey]) stats.finance[financeKey] = { old: 0, current: 0, total: 0 };

                    if (isCurrent) stats.finance[financeKey].current++;
                    else stats.finance[financeKey].old++;
                    stats.finance[financeKey].total++;

                    // Status Logic
                    let matchedStatus = statusList.find(s => s === statusRaw);
                    if (!matchedStatus) matchedStatus = statusList.find(s => statusRaw.includes(s));
                    const finalStatus = matchedStatus || "อื่นๆ";
                    
                    if (stats.status[finalStatus] !== undefined) stats.status[finalStatus]++;
                    else stats.status["อื่นๆ"]++;

                    if (!stats.financeDetails[financeKey]) stats.financeDetails[financeKey] = {};
                    if (!stats.financeDetails[financeKey][finalStatus]) stats.financeDetails[financeKey][finalStatus] = 0;
                    stats.financeDetails[financeKey][finalStatus]++;

                    // Source & Models Logic
                    let matchedSource = sourceList.find(s => sourceRaw.includes(s));
                    const finalSource = matchedSource || "อื่นๆ";
                    if (stats.source[finalSource] !== undefined) stats.source[finalSource]++;

                    if (brandRaw) {
                        stats.brands[brandRaw] = (stats.brands[brandRaw] || 0) + 1;
                        stats.models.push({ brand: brandRaw, model: modelRaw });
                    }
                });
            });
            
            renderDashboard(branchData);
        }

        function renderDashboard(data) {
            branches.forEach(branch => {
                const bData = data[branch];
                const card = document.createElement('div');
                card.className = "card-width bg-white rounded-xl shadow-lg flex flex-col border border-gray-200 flex-shrink-0 h-fit mb-4";
                
                card.innerHTML = `
                    <div class="bg-gradient-to-r from-gray-900 to-black text-white p-3 text-center rounded-t-xl sticky top-0 z-10 shadow-md">
                        <h2 class="text-xl font-bold text-red-500">${branch} <span class="text-xs text-gray-400 font-normal block">(WIN Only)</span></h2>
                    </div>
                `;

                const content = document.createElement('div');
                content.className = "p-4 space-y-5";

                // 1. Summary Grid
                const part1 = `
                    <div class="grid grid-cols-3 gap-3 text-center">
                        <div class="bg-blue-50 p-2 rounded-lg border border-blue-200 shadow-sm">
                            <div class="text-xs text-blue-600 font-semibold mb-1 uppercase tracking-wide">เคส WIN ทั้งหมด</div>
                            <div class="text-big text-blue-700">${bData.totalCases}</div>
                        </div>
                        <div class="bg-orange-50 p-2 rounded-lg border border-orange-200 shadow-sm">
                            <div class="text-xs text-orange-600 font-semibold mb-1 uppercase tracking-wide">ยอดยกมา</div>
                            <div class="text-big text-orange-600">${bData.carriedOver}</div>
                        </div>
                        <div class="bg-purple-50 p-2 rounded-lg border border-purple-200 shadow-sm">
                            <div class="text-xs text-purple-600 font-semibold mb-1 uppercase tracking-wide">เคสปัจจุบัน</div>
                            <div class="text-big text-purple-600">${bData.currentCases}</div>
                        </div>
                    </div>
                `;

                // 2. Finance Master Table REMOVED as requested

                // 3. Status Breakdown (Overall) - Enhanced for Portfolio Health
                let part3StatusHTML = `<div class="mt-4"><h3 class="font-bold text-gray-700 border-b pb-1 mb-2 text-sm flex items-center"><i class="fa-solid fa-list-check mr-2 text-blue-500"></i>สถานะเคส</h3><div class="grid grid-cols-1 gap-2">`;
                
                statusList.forEach(status => {
                    const count = bData.status[status] || 0;
                    
                    // Color Logic for Portfolio Health
                    let colorClass = "bg-gray-100 text-gray-500 border-l-4 border-gray-400"; // Default
                    let icon = "fa-circle";
                    let opacityClass = count === 0 ? "opacity-40 grayscale" : ""; 

                    if (status.includes("ส่งมอบแล้ว") || status.includes("ซื้อสด")) {
                        // GREEN: Success / Revenue
                        colorClass = "bg-green-100 text-green-800 border-l-4 border-green-500"; 
                        icon = "fa-circle-check"; 
                        opacityClass = ""; // Always show bright if needed, or keep logic
                    } else if (status.includes("ผ่าน") || status.includes("อนุมัติ")) {
                        // BLUE: High Probability / Approved
                        colorClass = "bg-blue-100 text-blue-800 border-l-4 border-blue-500"; 
                        icon = "fa-thumbs-up"; 
                        opacityClass = "";
                    } else if (status.includes("รอ") || status.includes("จอง")) {
                        // YELLOW/ORANGE: WIP / Processing
                        colorClass = "bg-amber-50 text-amber-800 border-l-4 border-amber-400"; 
                        icon = "fa-clock";
                    } else if (status.includes("รีเจค") || status.includes("ไม่ผ่าน") || status.includes("ยกเลิก") || status.includes("ติดต่อไม่ได้")) {
                        // RED: Loss / Failed
                        colorClass = "bg-red-100 text-red-800 border-l-4 border-red-500"; 
                        icon = "fa-circle-xmark";
                    }

                    if (count === 0) { 
                        opacityClass = "opacity-40"; 
                    }

                    part3StatusHTML += `
                        <div class="flex items-center justify-between px-3 py-2 rounded shadow-sm ${colorClass} ${opacityClass} text-xs transition hover:brightness-95">
                            <div class="flex items-center gap-2 overflow-hidden">
                                <i class="fa-solid ${icon} opacity-80 text-sm"></i>
                                <span class="truncate font-bold">${status}</span>
                            </div>
                            <span class="font-extrabold text-sm bg-white/50 px-2 py-0.5 rounded-full min-w-[24px] text-center backdrop-blur-sm border border-black/5">${count}</span>
                        </div>
                    `;
                });
                part3StatusHTML += `</div></div>`;

                // 4. Source & Models
                let part3SourceHTML = `<div class="mt-4"><h3 class="font-bold text-gray-700 border-b pb-1 mb-2 text-sm flex items-center"><i class="fa-solid fa-bullhorn mr-2 text-blue-500"></i>ที่มาลูกค้า</h3><div class="grid grid-cols-2 gap-2">`;
                let hasSource = false;
                sourceList.forEach(source => {
                    const count = bData.source[source] || 0;
                    if (count === 0) return;
                    hasSource = true;
                    const style = sourceStyles[source] || { icon: "fa-circle-question", bg: "bg-gray-50", border: "border-gray-200", text: "text-gray-700" };
                    part3SourceHTML += `
                        <div class="flex items-center justify-between p-2 rounded border ${style.bg} ${style.border} ${style.text}">
                             <div class="flex items-center gap-1.5 overflow-hidden">
                                <i class="fa-solid ${style.icon} text-xs opacity-70"></i>
                                <span class="text-[10px] truncate leading-tight font-medium">${source}</span>
                            </div>
                            <span class="font-bold text-xs">${count}</span>
                        </div>
                    `;
                });
                if (!hasSource) part3SourceHTML += `<div class="col-span-2 text-center text-gray-400 text-xs italic">ไม่มีข้อมูลที่มา</div>`;
                part3SourceHTML += `</div></div>`;

                let part4HTML = `<div class="mt-4"><h3 class="font-bold text-gray-700 border-b pb-1 mb-2 text-sm flex items-center"><i class="fa-solid fa-car mr-2 text-blue-500"></i>รุ่นรถที่ขาย (WIN)</h3>`;
                part4HTML += `<div class="flex flex-wrap gap-2 mb-3">`;
                if(Object.keys(bData.brands).length === 0) part4HTML += `<span class="text-gray-400 text-xs italic">ไม่มีข้อมูล</span>`;
                for(const [brand, count] of Object.entries(bData.brands)) {
                    part4HTML += `
                        <div class="flex items-center bg-gray-700 text-white rounded-md px-2 py-1 shadow-sm">
                            <span class="text-[10px] uppercase font-semibold mr-2">${brand}</span>
                            <span class="text-xs font-bold bg-gray-500 px-1.5 rounded text-white">${count}</span>
                        </div>
                    `;
                }
                part4HTML += `</div>`;
                const modelCounts = bData.models.reduce((acc, curr) => {
                    const key = `${curr.brand}|${curr.model}`;
                    if (!acc[key]) acc[key] = { brand: curr.brand, model: curr.model, count: 0 };
                    acc[key].count++;
                    return acc;
                }, {});
                const sortedModels = Object.values(modelCounts).sort((a, b) => b.count - a.count);
                part4HTML += `
                    <div class="overflow-hidden border border-gray-200 rounded-lg shadow-sm">
                        <div class="max-h-60 overflow-y-auto custom-scrollbar">
                            <table class="min-w-full text-xs text-left">
                                <thead class="bg-gray-50 font-bold text-gray-600 sticky top-0 z-10 shadow-sm">
                                    <tr>
                                        <th class="px-3 py-2 whitespace-nowrap">ยี่ห้อ</th>
                                        <th class="px-3 py-2 w-full">รุ่น</th>
                                        <th class="px-3 py-2 text-center whitespace-nowrap">จำนวน</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-100 bg-white">
                `;
                if(sortedModels.length === 0) {
                     part4HTML += `<tr><td colspan="3" class="px-3 py-4 text-center text-gray-400">ไม่มีข้อมูลรถยนต์</td></tr>`;
                } else {
                    sortedModels.forEach(item => {
                        part4HTML += `
                            <tr class="hover:bg-blue-50 transition-colors">
                                <td class="px-3 py-2 font-semibold whitespace-nowrap text-gray-700 border-r border-gray-50">${item.brand}</td>
                                <td class="px-3 py-2 text-gray-600">${item.model || "-"}</td>
                                <td class="px-3 py-2 text-center font-bold text-blue-600 bg-blue-50/50">${item.count}</td>
                            </tr>
                        `;
                    });
                }
                part4HTML += `</tbody></table></div></div></div>`;

                // ASSEMBLY
                content.innerHTML = part1 + part3StatusHTML + part3SourceHTML + part4HTML;
                card.appendChild(content);
                container.appendChild(card);
            });
        }

        init();
    </script>
</body>
</html>
