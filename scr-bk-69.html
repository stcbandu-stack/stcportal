<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>สรุปยอดการจองรถมือสอง 2569</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- PapaParse for CSV -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <!-- Google Fonts: Sarabun -->
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <meta name="robots" content="noindex, nofollow">
    <meta name="googlebot" content="noindex">

    <style>
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #f0f2f5; 
        }
        
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        ::-webkit-scrollbar-thumb {
            background: #888; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555; 
        }

        .card-width {
            width: 400px;
            min-width: 400px;
        }
        .text-big {
            font-size: 3.5rem;
            line-height: 1;
            font-weight: 800;
            text-shadow: 2px 2px 0px rgba(0,0,0,0.1);
        }
        
        .vivid-gradient {
            background: linear-gradient(45deg, #FF0055, #FF5500, #FFCC00, #00CC55, #0055FF, #5500FF);
            background-size: 300% 300%;
            animation: gradientBG 10s ease infinite;
        }
        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 min-h-screen flex flex-col min-w-fit font-sans">

    <!-- Header & Filter -->
    <header id="main-header" class="bg-white shadow-md p-4 sticky top-0 z-50 w-full border-b-4 border-indigo-600 transition-all duration-200">
        <div class="flex flex-col md:flex-row justify-start items-center gap-8">
            <div class="flex items-center">
                <div class="bg-indigo-600 text-white p-2 rounded-lg mr-3 shadow-lg">
                    <i class="fa-solid fa-chart-line text-2xl"></i>
                </div>
                <h1 class="text-2xl font-extrabold text-indigo-900 tracking-tight">สรุปยอดการจองมือสอง 2569</h1>
            </div>
            
            <div class="flex items-center gap-2 bg-indigo-50 p-2 rounded-xl border-2 border-indigo-100 shadow-sm">
                <label for="monthFilter" class="font-bold text-indigo-800"><i class="fa-regular fa-calendar-days mr-1"></i> เดือน:</label>
                <select id="monthFilter" class="border-2 border-indigo-300 rounded-lg px-3 py-1.5 focus:outline-none focus:ring-2 focus:ring-indigo-500 font-semibold text-indigo-700 bg-white">
                    <!-- Options generated by JS -->
                </select>
                <button onclick="loadData()" class="bg-gradient-to-r from-indigo-600 to-violet-600 text-white px-4 py-1.5 rounded-lg hover:from-indigo-700 hover:to-violet-700 transition shadow-md font-bold transform active:scale-95">
                    <i class="fa-solid fa-sync-alt mr-1"></i> โหลด
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 p-6 flex gap-6 items-start" id="dashboard-container">
        <div class="flex flex-col items-center justify-center w-full h-64 text-gray-400">
            <i class="fa-solid fa-circle-notch fa-spin text-5xl mb-4 text-indigo-500"></i>
            <p class="text-lg font-semibold animate-pulse">กำลังเตรียมข้อมูลสุดจึ้ง...</p>
        </div>
    </main>

    <script>
        // ==========================================
        // ส่วนที่ 1: การตั้งค่า (Configuration)
        // ==========================================

        const MAIN_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vT7Us7qH3I4YOsfRgIKYGd9ZAuefUOJVd2XEQHdhDEbjO2bAVBsYfBui9bWnkTU4e08iJxDzAuwO-CV/pub?gid=409516882&single=true&output=csv";

        const csvLinks = {
            "มกราคม": MAIN_CSV_URL,
            "กุมภาพันธ์": "", 
            "มีนาคม": "",
            "เมษายน": "",
            "พฤษภาคม": "",
            "มิถุนายน": "",
            "กรกฎาคม": "",
            "สิงหาคม": "",
            "กันยายน": "",
            "ตุลาคม": "",
            "พฤศจิกายน": "",
            "ธันวาคม": ""
        };

        const financeStyles = {
            "WIN": { bg: "#b8b8b8", text: "#ff0000" },
            "TB": { bg: "#4c7abd", text: "#ffff00" },
            "SCB": { bg: "#713896", text: "#ffc200" },
            "KB": { bg: "#4ab958", text: "#ffffff" },
            "KK": { bg: "#cec1d6", text: "#432856" },
            "NL": { bg: "#f2f2f2", text: "#b71100" },
            "TIL": { bg: "#ff1800", text: "#afff00" },
            "NISSAN": { bg: "#f2f2f2", text: "#b71100" },
            "Krungsri": { bg: "#ffb600", text: "#3d3a34" },
            "ซื้อสด": { bg: "#acd037", text: "#000000" }
        };

        const statusConfig = {
            "จอง": { color: "bg-blue-100 text-blue-800 border-blue-400", icon: "fa-bookmark" },
            "รอเอกสาร": { color: "bg-yellow-100 text-yellow-800 border-yellow-400", icon: "fa-file-invoice" },
            "รออนุมัติ": { color: "bg-orange-100 text-orange-800 border-orange-400", icon: "fa-clock" },
            "รอเซนสัญญา": { color: "bg-purple-100 text-purple-800 border-purple-400", icon: "fa-file-signature" },
            "อนุมัติ-รอส่งมอบ": { color: "bg-teal-100 text-teal-800 border-teal-400", icon: "fa-check-double" },
            "ซื้อสด-รอส่งมอบ": { color: "bg-lime-100 text-lime-800 border-lime-400", icon: "fa-money-bill-wave" },
            "ส่งมอบแล้ว": { color: "bg-green-500 text-white border-green-700", icon: "fa-flag-checkered" },
            "ยกเลิกเคส": { color: "bg-red-100 text-red-800 border-red-400", icon: "fa-ban" },
            "ไม่ผ่านเงื่อนไข / คุณสมบัติไม่ครบ": { color: "bg-gray-200 text-gray-700 border-gray-400", icon: "fa-user-slash" },
            "รีเจค": { color: "bg-red-600 text-white border-red-800", icon: "fa-circle-xmark" }
        };
        
        const statusList = Object.keys(statusConfig);
        
        const vividPalette = [
            { bg: "bg-pink-100", text: "text-pink-700", border: "border-pink-400", icon: "fa-users" },
            { bg: "bg-indigo-100", text: "text-indigo-700", border: "border-indigo-400", icon: "fa-user-tag" },
            { bg: "bg-teal-100", text: "text-teal-700", border: "border-teal-400", icon: "fa-id-card" },
            { bg: "bg-orange-100", text: "text-orange-700", border: "border-orange-400", icon: "fa-layer-group" },
            { bg: "bg-cyan-100", text: "text-cyan-700", border: "border-cyan-400", icon: "fa-briefcase" },
            { bg: "bg-lime-100", text: "text-lime-700", border: "border-lime-400", icon: "fa-seedling" },
            { bg: "bg-fuchsia-100", text: "text-fuchsia-700", border: "border-fuchsia-400", icon: "fa-wand-magic-sparkles" },
            { bg: "bg-rose-100", text: "text-rose-700", border: "border-rose-400", icon: "fa-heart" }
        ];

        const monthAliases = {
            "มกราคม": ["มกราคม", "ม.ค.", "/01/", "/1/", "-01-", "-1-", "jan"],
            "กุมภาพันธ์": ["กุมภาพันธ์", "ก.พ.", "/02/", "/2/", "-02-", "-2-", "feb"],
            "มีนาคม": ["มีนาคม", "มี.ค.", "/03/", "/3/", "-03-", "-3-", "mar"],
            "เมษายน": ["เมษายน", "เม.ย.", "/04/", "/4/", "-04-", "-4-", "apr"],
            "พฤษภาคม": ["พฤษภาคม", "พ.ค.", "/05/", "/5/", "-05-", "-5-", "may"],
            "มิถุนายน": ["มิถุนายน", "มิ.ย.", "/06/", "/6/", "-06-", "-6-", "jun"],
            "กรกฎาคม": ["กรกฎาคม", "ก.ค.", "/07/", "/7/", "-07-", "-7-", "jul"],
            "สิงหาคม": ["สิงหาคม", "ส.ค.", "/08/", "/8/", "-08-", "-8-", "aug"],
            "กันยายน": ["กันยายน", "ก.ย.", "/09/", "/9/", "-09-", "-9-", "sep"],
            "ตุลาคม": ["ตุลาคม", "ต.ค.", "/10/", "-10-", "oct"],
            "พฤศจิกายน": ["พฤศจิกายน", "พ.ย.", "/11/", "-11-", "nov"],
            "ธันวาคม": ["ธันวาคม", "ธ.ค.", "/12/", "-12-", "dec"]
        };

        const monthFilter = document.getElementById('monthFilter');
        const container = document.getElementById('dashboard-container');

        // ใช้ ResizeObserver เพื่อติดตามความสูงของ Header อย่างแม่นยำ
        const headerObserver = new ResizeObserver(entries => {
            for (let entry of entries) {
                const height = entry.contentRect.height + (parseFloat(getComputedStyle(entry.target).paddingTop) || 0) + (parseFloat(getComputedStyle(entry.target).paddingBottom) || 0);
                // ปรับตำแหน่ง Sticky ของการ์ด
                document.querySelectorAll('.card-sticky-header').forEach(el => {
                    // ใช้ boundingClientRect จะแม่นยำกว่าสำหรับการหาพื้นที่ที่กินที่จริงรวม border
                    el.style.top = `${entry.target.getBoundingClientRect().height}px`;
                });
            }
        });

        // เริ่มสังเกตการณ์ที่ Header หลัก
        const mainHeader = document.getElementById('main-header');
        if (mainHeader) {
            headerObserver.observe(mainHeader);
        }

        function init() {
            monthFilter.innerHTML = '';
            for (const month in csvLinks) {
                const option = document.createElement('option');
                option.value = month;
                option.textContent = month;
                monthFilter.appendChild(option);
            }
            loadData();
        }

        function loadData() {
            const selectedMonth = monthFilter.value;
            const url = csvLinks[selectedMonth];

            if (!url) {
                container.innerHTML = `<div class="w-full text-center text-red-500 font-bold p-10 bg-white rounded-xl shadow">ยังไม่ได้ระบุลิงก์ CSV สำหรับเดือน ${selectedMonth}</div>`;
                return;
            }

            container.innerHTML = `<div class="w-full h-64 flex items-center justify-center text-gray-500"><p class="text-center"><i class="fa-solid fa-spinner fa-spin text-4xl mb-4 text-indigo-600"></i><br>กำลังดึงข้อมูล...</p></div>`;

            Papa.parse(url, {
                download: true,
                header: true,
                skipEmptyLines: true,
                transformHeader: function(h) { return h.trim(); },
                complete: function(results) {
                    processData(results.data, selectedMonth);
                },
                error: function(err) {
                    container.innerHTML = `<div class="text-red-500 font-bold p-10 bg-white rounded-xl shadow">เกิดข้อผิดพลาดในการโหลดไฟล์: ${err.message}</div>`;
                }
            });
        }

        function findColumnMap(dataRows) {
            if (!dataRows || dataRows.length === 0) return {};
            const keys = Object.keys(dataRows[0]);
            
            const mapping = {};
            const targets = {
                branch: ["สาขาที่ขาย", "สาขา"], 
                bookingMonth: ["เดือนจอง", "เดือน"],
                bookingDate: ["วันจอง", "วันที่", "date"],
                finance: ["ไฟแนนซ์", "Finance"],
                status: ["สถานะ", "Status"],
                source: ["สังกัด"], 
                brand: ["ยี่ห้อ", "Brand"],
                model: ["รุ่น", "Model"]
            };

            for (const [keyName, searchArr] of Object.entries(targets)) {
                const foundKey = keys.find(k => {
                    const cleanKey = k.replace(/\s+/g, '').toLowerCase(); 
                    return searchArr.some(s => cleanKey.includes(s.toLowerCase()));
                });
                mapping[keyName] = foundKey || null;
            }
            return mapping;
        }

        function isMonthMatch(text, monthName) {
            if (!text) return false;
            const aliases = monthAliases[monthName] || [monthName];
            const lowerText = text.toLowerCase();
            return aliases.some(alias => lowerText.includes(alias));
        }

        function createStatsObject() {
            const stats = {
                totalCases: 0,
                cashPurchase: 0,
                finance: {},
                status: {},
                source: {}, 
                brands: {},
                models: []
            };
            Object.keys(financeStyles).forEach(f => stats.finance[f] = 0); 
            statusList.forEach(s => stats.status[s] = 0);
            return stats;
        }

        function mapFinanceName(rawName) {
            if (!rawName) return "Other";
            let name = rawName.toUpperCase();
            
            if (name.includes("WIN")) return "WIN";
            if (name.includes("TTB") || name.includes("ทหารไทย") || name.includes("TB")) return "TB";
            if (name.includes("SCB") || name.includes("ไทยพาณิชย์")) return "SCB";
            if (name.includes("KLEASING") || name.includes("กสิกร") || name.includes("KBANK")) return "KB";
            if (name.includes("KKP") || name.includes("เกียรตินาคิน") || name.includes("เกียรติ")) return "KK";
            if (name.includes("NISSAN")) return "NISSAN"; 
            if (name.includes("NL")) return "NL";
            if (name.includes("TIL") || name.includes("ทิสโก้") || name.includes("TISCO")) return "TIL";
            if (name.includes("KRUNGSRI") || name.includes("กรุงศรี")) return "Krungsri";
            if (name.includes("สด") || name.includes("CASH")) return "ซื้อสด";

            return "Other"; 
        }

        function mapStatusName(rawStatus) {
            if (!rawStatus) return "อื่นๆ";
            let s = rawStatus.trim();
            
            if (s.includes("ส่งมอบแล้ว")) return "ส่งมอบแล้ว";
            if (s.includes("อนุมัติ") && (s.includes("รอส่งมอบ") || s.includes("รอปล่อย") || s.includes("ผ่าน"))) return "อนุมัติ-รอส่งมอบ";
            if (s.includes("รออนุมัติ") || s.includes("รอผล") || s.includes("รอไฟแนนซ์")) return "รออนุมัติ";
            if (s.includes("รอเซ็น") || s.includes("รอเซน")) return "รอเซนสัญญา";
            if (s.includes("เอกสาร") || s.includes("เตรียม")) return "รอเอกสาร";
            if (s.includes("จอง")) return "จอง";
            if (s.includes("ยกเลิก")) return "ยกเลิกเคส";
            if (s.includes("รีเจค") || s.includes("REJECT")) return "รีเจค";
            if (s.includes("ไม่ผ่าน")) return "ไม่ผ่านเงื่อนไข / คุณสมบัติไม่ครบ";
            if (s.includes("สด")) return "ซื้อสด-รอส่งมอบ";

            return "อื่นๆ"; 
        }

        function processData(data, selectedMonth) {
            const colMap = findColumnMap(data);
            
            let branchData = {
                "รวมทั้งหมด": createStatsObject()
            };

            data.forEach(row => {
                const branchRaw = (colMap.branch ? row[colMap.branch] : "").trim();
                const financeRaw = (colMap.finance ? row[colMap.finance] : "Other").trim();
                const statusRaw = (colMap.status ? row[colMap.status] : "").trim();
                const sourceRaw = (colMap.source ? row[colMap.source] : "ไม่ระบุสังกัด").trim();
                const brandRaw = (colMap.brand ? row[colMap.brand] : "").trim();
                const modelRaw = (colMap.model ? row[colMap.model] : "").trim();
                
                if (!branchRaw) return;

                let targetBranches = ["รวมทั้งหมด"];

                if (branchRaw) {
                    if (!branchData[branchRaw]) {
                        branchData[branchRaw] = createStatsObject();
                    }
                    targetBranches.push(branchRaw);
                }

                targetBranches.forEach(bKey => {
                    const stats = branchData[bKey];

                    stats.totalCases++;
                    if (financeRaw.includes("สด") || financeRaw.includes("Cash")) {
                        stats.cashPurchase++;
                    }

                    let financeKey = mapFinanceName(financeRaw);
                    if (stats.finance[financeKey] !== undefined) {
                        stats.finance[financeKey]++;
                    }

                    let statusKey = mapStatusName(statusRaw);
                    if (stats.status[statusKey] !== undefined) {
                        stats.status[statusKey]++;
                    } 

                    const cleanSource = sourceRaw || "ไม่ระบุ";
                    stats.source[cleanSource] = (stats.source[cleanSource] || 0) + 1;

                    if (brandRaw) {
                        stats.brands[brandRaw] = (stats.brands[brandRaw] || 0) + 1;
                        stats.models.push({ brand: brandRaw, model: modelRaw });
                    }
                });
            });

            renderDashboard(branchData);
        }

        function renderDashboard(data) {
            container.innerHTML = '';

            let allBranches = Object.keys(data);
            allBranches.sort((a, b) => {
                if (a === "รวมทั้งหมด") return -1;
                if (b === "รวมทั้งหมด") return 1;
                return a.localeCompare(b, 'th');
            });

            // ตรวจสอบความสูง Header ปัจจุบันเพื่อใช้กำหนด top ทันที
            const mainHeader = document.getElementById('main-header');
            const currentHeaderHeight = mainHeader ? mainHeader.getBoundingClientRect().height : 80;

            allBranches.forEach(branch => {
                const bData = data[branch];
                
                if (branch !== "รวมทั้งหมด" && bData.totalCases === 0) return;

                const card = document.createElement('div');
                // ลบ overflow-hidden ออก เพื่อให้ sticky ทำงานได้ถูกต้อง
                card.className = "card-width bg-white rounded-2xl shadow-xl flex flex-col border border-gray-200 flex-shrink-0 h-fit mb-4 hover:shadow-2xl transition-shadow duration-300";
                
                // แก้ไข: เอา relative ออกจากส่วนหัว และใส่ rounded-t-2xl เพื่อให้มุมโค้งสวยงามเหมือนเดิม (เพราะไม่มี overflow:hidden มาตัดให้แล้ว)
                card.innerHTML = `
                    <div class="card-sticky-header vivid-gradient text-white p-4 text-center sticky z-40 shadow-md rounded-t-2xl" style="top: ${currentHeaderHeight}px;">
                        <div class="absolute top-0 left-0 w-full h-full bg-black opacity-10 rounded-t-2xl"></div>
                        <h2 class="text-2xl font-black relative z-10 uppercase tracking-wide drop-shadow-md">${branch}</h2>
                    </div>
                `;

                const content = document.createElement('div');
                content.className = "p-4 space-y-5 bg-white relative z-10 rounded-b-2xl"; // เพิ่ม rounded-b ให้ส่วนเนื้อหา

                const part1 = `
                    <div class="grid grid-cols-2 gap-3 text-center">
                        <div class="bg-blue-600 text-white p-4 rounded-xl shadow-lg transform hover:-translate-y-1 transition duration-200">
                            <div class="text-sm font-bold uppercase opacity-80 mb-2">เคสทั้งหมด</div>
                            <div class="text-big">${bData.totalCases}</div>
                        </div>
                        <div class="bg-emerald-500 text-white p-4 rounded-xl shadow-lg transform hover:-translate-y-1 transition duration-200">
                            <div class="text-sm font-bold uppercase opacity-80 mb-2">ซื้อเงินสด</div>
                            <div class="text-big">${bData.cashPurchase}</div>
                        </div>
                    </div>
                `;

                let part2HTML = `<div class="space-y-2 pt-2"><h3 class="font-bold text-gray-800 border-b-2 border-gray-200 pb-1 text-base flex items-center"><i class="fa-solid fa-file-invoice-dollar mr-2 text-indigo-500"></i>ข้อมูลไฟแนนซ์</h3>`;
                
                Object.keys(financeStyles).forEach(fin => {
                    const count = bData.finance[fin];
                    const style = financeStyles[fin];
                    
                    part2HTML += `
                        <div class="flex items-center justify-between rounded-lg px-3 py-2 shadow-sm border border-gray-200 transform hover:scale-[1.01] transition-transform" 
                             style="background-color: ${style.bg};">
                            <div class="font-bold text-sm w-full truncate drop-shadow-sm" style="color: ${style.text};">${fin}</div>
                            <div class="bg-white rounded-lg px-3 py-0.5 shadow-inner border border-gray-300 min-w-[50px] text-center">
                                <span class="font-black text-xl leading-none text-gray-800">${count}</span>
                            </div>
                        </div>
                    `;
                });
                part2HTML += `</div>`;

                let part3StatusHTML = `<div class="mt-4"><h3 class="font-bold text-gray-800 border-b-2 border-gray-200 pb-1 mb-3 text-base flex items-center"><i class="fa-solid fa-list-check mr-2 text-indigo-500"></i>สถานะเคส</h3><div class="grid grid-cols-1 gap-2">`;
                
                statusList.forEach(status => {
                    const count = bData.status[status];
                    const conf = statusConfig[status];

                    part3StatusHTML += `
                        <div class="flex items-center justify-between px-3 py-2 rounded-lg border-l-4 shadow-sm ${conf.color} bg-opacity-80">
                            <div class="flex items-center gap-3 overflow-hidden">
                                <i class="fa-solid ${conf.icon} text-lg w-6 text-center"></i>
                                <span class="text-sm font-bold truncate leading-tight">${status}</span>
                            </div>
                            <span class="font-black text-xl">${count}</span>
                        </div>
                    `;
                });
                part3StatusHTML += `</div></div>`;

                const sortedSources = Object.entries(bData.source).sort((a,b) => b[1] - a[1]);
                let part3SourceHTML = `<div class="mt-4"><h3 class="font-bold text-gray-800 border-b-2 border-gray-200 pb-1 mb-3 text-base flex items-center"><i class="fa-solid fa-sitemap mr-2 text-indigo-500"></i>สังกัด</h3><div class="grid grid-cols-2 gap-2">`;
                
                sortedSources.forEach(([sourceName, count], index) => {
                    const style = vividPalette[index % vividPalette.length];
                    part3SourceHTML += `
                        <div class="flex items-center justify-between p-2 rounded-lg border-2 shadow-sm ${style.bg} ${style.border} ${style.text}">
                             <div class="flex items-center gap-2 overflow-hidden">
                                <i class="fa-solid ${style.icon} text-sm opacity-80"></i>
                                <span class="text-[11px] font-bold truncate leading-tight" title="${sourceName}">${sourceName}</span>
                            </div>
                            <span class="font-black text-lg bg-white/50 px-2 rounded-md">${count}</span>
                        </div>
                    `;
                });
                if (sortedSources.length === 0) part3SourceHTML += `<div class="col-span-2 text-center text-gray-400 text-sm italic py-2">ไม่มีข้อมูลสังกัด</div>`;
                part3SourceHTML += `</div></div>`;

                let part4HTML = `<div class="mt-4 bg-gray-50 p-3 rounded-xl border border-gray-200"><h3 class="font-bold text-gray-700 border-b pb-1 mb-3 text-sm flex items-center"><i class="fa-solid fa-car mr-2 text-indigo-500"></i>ยี่ห้อรถ</h3>`;
                part4HTML += `<div class="flex flex-wrap gap-2 mb-4">`;
                if(Object.keys(bData.brands).length === 0) part4HTML += `<span class="text-gray-400 text-xs italic">ไม่มีข้อมูล</span>`;
                
                const sortedBrands = Object.entries(bData.brands).sort((a,b) => b[1] - a[1]);
                for(const [brand, count] of sortedBrands) {
                    part4HTML += `
                        <div class="flex flex-col items-center bg-slate-800 text-white rounded-lg p-2 min-w-[60px] shadow-md border-b-4 border-slate-600">
                            <span class="text-[10px] font-bold uppercase tracking-wider">${brand}</span>
                            <span class="text-xl font-black leading-tight text-yellow-400">${count}</span>
                        </div>
                    `;
                }
                part4HTML += `</div>`;

                const modelCounts = bData.models.reduce((acc, curr) => {
                    const key = `${curr.brand}|${curr.model}`;
                    if (!acc[key]) acc[key] = { brand: curr.brand, model: curr.model, count: 0 };
                    acc[key].count++;
                    return acc;
                }, {});
                const sortedModels = Object.values(modelCounts).sort((a, b) => b.count - a.count);

                part4HTML += `
                    <div class="overflow-hidden border border-gray-300 rounded-lg shadow-inner bg-white">
                        <table class="min-w-full text-xs text-left">
                            <thead class="bg-gray-200 font-bold text-gray-700 uppercase">
                                <tr>
                                    <th class="px-3 py-2 whitespace-nowrap">ยี่ห้อ</th>
                                    <th class="px-3 py-2 w-full">รุ่น</th>
                                    <th class="px-3 py-2 text-center whitespace-nowrap">จำนวน</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-100">
                `;
                if(sortedModels.length === 0) {
                     part4HTML += `<tr><td colspan="3" class="px-3 py-4 text-center text-gray-400">ไม่มีข้อมูลรุ่นรถ</td></tr>`;
                } else {
                    sortedModels.forEach((item, idx) => {
                        const rowBg = idx % 2 === 0 ? 'bg-white' : 'bg-gray-50';
                        part4HTML += `
                            <tr class="${rowBg} hover:bg-indigo-50 transition-colors">
                                <td class="px-3 py-2 font-bold whitespace-nowrap text-[11px] text-indigo-900">${item.brand}</td>
                                <td class="px-3 py-2 text-gray-600 text-[11px] font-medium">${item.model || "-"}</td>
                                <td class="px-3 py-2 text-center">
                                    <span class="inline-block px-2 py-0.5 rounded-full bg-indigo-100 text-indigo-700 font-bold text-[10px] border border-indigo-200">
                                        ${item.count}
                                    </span>
                                </td>
                            </tr>
                        `;
                    });
                }
                part4HTML += `</tbody></table></div></div>`;

                content.innerHTML = part1 + part2HTML + part3StatusHTML + part3SourceHTML + part4HTML;
                card.appendChild(content);
                container.appendChild(card);
            });
            
            // เรียกซ้ำอีกครั้งเพื่อให้แน่ใจว่าค่าถูกต้องหลังจาก DOM สร้างเสร็จ
            if (mainHeader) {
                // Manually trigger
                document.querySelectorAll('.card-sticky-header').forEach(el => {
                    el.style.top = `${mainHeader.getBoundingClientRect().height}px`;
                });
            }
        }

        init();

    </script>
</body>
</html>
